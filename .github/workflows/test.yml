name: CI

on:
  push:
    branches:
      - master
    tags:
      - v0.*

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.9', '3.10', '3.11', '3.12' ]
    env:
        GITHUB_ACTIONS: true
    steps:
      - uses: actions/checkout@v2
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - name: setup SirixDB server
        run: bash ./test.sh
      - name: verify services are running
        run: |
          docker ps
          echo "Checking Keycloak..."
          curl -f http://localhost:8080/realms/master || echo "Keycloak not ready"
          echo "Checking SirixDB..."
          curl -f http://localhost:9443 || echo "SirixDB not ready"
      - name: install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-all.txt
      - name: test with pytest
        run: python -m pytest --cov=pysirix --cov-config=.coveragerc -v -s
      - name: show docker logs on failure
        if: failure()
        run: |
          docker compose -f ./tests/resources/docker-compose.yml logs
